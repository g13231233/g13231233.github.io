<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时金币点击游戏 - P2P版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
        }
        
        .container {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #ff9f43;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .player-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        #player-name {
            padding: 10px 15px;
            border: 2px solid #ff9f43;
            border-radius: 50px;
            font-size: 1rem;
            width: 200px;
        }
        
        #save-name {
            background: #ff9f43;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        #save-name:hover {
            background: #ff7f17;
        }
        
        .connection-panel {
            background: #e8f4fc;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
        }
        
        .status-indicator.connected {
            background: #2ecc71;
        }
        
        .game-area {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }
        
        .clicker-section {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .coin {
            width: 180px;
            height: 180px;
            background: linear-gradient(135deg, #ffd700 0%, #ff9d00 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
            border: 8px solid #daa520;
            transition: transform 0.2s;
        }
        
        .coin:active {
            transform: scale(0.95);
        }
        
        .coin i {
            font-size: 5rem;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 20px;
        }
        
        .stat-box {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            width: 45%;
        }
        
        .stat-box h3 {
            color: #6c757d;
            font-size: 1rem;
            margin-bottom: 5px;
        }
        
        .stat-box p {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff9f43;
        }
        
        .leaderboard-section {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .leaderboard-section h2 {
            color: #ff9f43;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        #players-list {
            list-style: none;
        }
        
        .player-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            animation: fadeIn 0.5s;
        }
        
        .player-item.me {
            background: linear-gradient(135deg, #d4edff 0%, #a7d9ff 100%);
            border: 2px solid #4a9eff;
        }
        
        .player-item.offline {
            opacity: 0.6;
        }
        
        .player-item:nth-child(1) {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .player-item:nth-child(2) {
            background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%);
        }
        
        .player-item:nth-child(3) {
            background: linear-gradient(135deg, #fdcb6e 0%, #ff9f43 100%);
        }
        
        .player-name {
            font-weight: 500;
        }
        
        .player-coins {
            color: #ff9f43;
            font-weight: bold;
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .instructions h2 {
            color: #ff9f43;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .instructions ul {
            list-style: none;
            padding: 0 15px;
        }
        
        .instructions li {
            margin-bottom: 10px;
            padding-left: 25px;
            position: relative;
        }
        
        .instructions li i {
            position: absolute;
            left: 0;
            top: 3px;
            color: #ff9f43;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .last-updated {
            text-align: center;
            font-size: 0.8rem;
            color: #666;
            margin-top: 10px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        #reset-game {
            background: #ff6b6b;
            color: white;
        }
        
        #reset-game:hover {
            background: #ff5252;
        }
        
        #copy-link {
            background: #4a9eff;
            color: white;
        }
        
        #copy-link:hover {
            background: #3a8aee;
        }
        
        @media (max-width: 768px) {
            .game-area {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .coin {
                width: 150px;
                height: 150px;
            }
            
            .coin i {
                font-size: 4rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>实时金币点击游戏</h1>
            <p>点击金币赚取财富，与朋友们一较高下！</p>
            <div class="player-info">
                <input type="text" id="player-name" placeholder="输入你的玩家名称" maxlength="15">
                <button id="save-name">保存名称</button>
            </div>
            <div class="connection-panel">
                <div class="connection-status">
                    <div class="status-indicator" id="status-indicator"></div>
                    <span id="connection-status-text">未连接</span>
                </div>
                <p id="player-count">已连接玩家: 0</p>
                <div class="action-buttons">
                    <button id="copy-link">复制邀请链接</button>
                    <button id="reset-game">重置游戏</button>
                </div>
            </div>
        </header>
        
        <div class="game-area">
            <div class="clicker-section">
                <h2>点击金币！</h2>
                <div class="coin" id="coin">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="stats">
                    <div class="stat-box">
                        <h3>你的金币</h3>
                        <p id="coins-count">0</p>
                    </div>
                    <div class="stat-box">
                        <h3>点击次数</h3>
                        <p id="clicks-count">0</p>
                    </div>
                </div>
            </div>
            
            <div class="leaderboard-section">
                <h2>实时排行榜</h2>
                <ul id="players-list">
                    <li class="player-item">
                        <span class="player-name">等待连接...</span>
                        <span class="player-coins">0 金币</span>
                    </li>
                </ul>
                <div class="last-updated" id="last-updated">最后更新: --</div>
            </div>
        </div>
        
        <div class="instructions">
            <h2>游戏说明</h2>
            <ul>
                <li><i class="fas fa-info-circle"></i> 点击中央的金币可以增加你的金币数量</li>
                <li><i class="fas fa-trophy"></i> 与同一网络下的其他玩家竞争排行榜首位</li>
                <li><i class="fas fa-plug"></i> 使用P2P技术，无需服务器即可实时同步</li>
                <li><i class="fas fa-user"></i> 请先在上方输入你的玩家名称并保存</li>
                <li><i class="fas fa-share-alt"></i> 点击"复制邀请链接"分享给朋友一起玩</li>
            </ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 玩家数据
            let player = {
                name: '',
                coins: 0,
                clicks: 0,
                id: generatePlayerId(),
                lastSeen: Date.now()
            };
            
            // 连接的其他玩家
            let connectedPlayers = {};
            let peer = null;
            let connections = [];
            
            // DOM元素
            const coinElement = document.getElementById('coin');
            const coinsCountElement = document.getElementById('coins-count');
            const clicksCountElement = document.getElementById('clicks-count');
            const playerNameInput = document.getElementById('player-name');
            const saveNameButton = document.getElementById('save-name');
            const playersListElement = document.getElementById('players-list');
            const lastUpdatedElement = document.getElementById('last-updated');
            const resetButton = document.getElementById('reset-game');
            const copyLinkButton = document.getElementById('copy-link');
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('connection-status-text');
            const playerCountElement = document.getElementById('player-count');
            
            // 初始化
            loadPlayerData();
            updateDisplay();
            initializePeerConnection();
            
            // 生成玩家ID
            function generatePlayerId() {
                return 'player-' + Math.floor(Math.random() * 1000000);
            }
            
            // 加载玩家数据
            function loadPlayerData() {
                const savedData = localStorage.getItem('coinClickerPlayer');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    player.name = data.name || '';
                    player.coins = data.coins || 0;
                    player.clicks = data.clicks || 0;
                    playerNameInput.value = player.name;
                }
            }
            
            // 保存玩家数据
            function savePlayerData() {
                localStorage.setItem('coinClickerPlayer', JSON.stringify({
                    name: player.name,
                    coins: player.coins,
                    clicks: player.clicks,
                    id: player.id
                }));
            }
            
            // 更新显示
            function updateDisplay() {
                coinsCountElement.textContent = player.coins;
                clicksCountElement.textContent = player.clicks;
            }
            
            // 初始化Peer连接
            function initializePeerConnection() {
                // 从URL获取房间ID或生成新的
                const urlParams = new URLSearchParams(window.location.search);
                let roomId = urlParams.get('room');
                
                if (!roomId) {
                    roomId = 'coin-clicker-default-room';
                    window.history.replaceState({}, '', `${window.location.pathname}?room=${roomId}`);
                }
                
                // 使用房间ID作为PeerID，确保所有玩家连接到同一个"房间"
                peer = new Peer(`${roomId}-${player.id}`);
                
                peer.on('open', function(id) {
                    console.log('Peer连接已建立，ID:', id);
                    statusIndicator.classList.add('connected');
                    statusText.textContent = '已连接';
                    
                    // 监听其他玩家的连接
                    peer.on('connection', function(conn) {
                        console.log('收到连接来自:', conn.peer);
                        setupConnection(conn);
                    });
                    
                    // 尝试连接到房间主机
                    if (!id.endsWith(player.id)) { // 如果不是主机自己
                        const hostConn = peer.connect(roomId);
                        setupConnection(hostConn);
                    }
                    
                    // 广播自己的存在
                    broadcastPlayerData();
                });
                
                peer.on('error', function(err) {
                    console.error('Peer错误:', err);
                    statusText.textContent = '连接错误: ' + err.type;
                });
            }
            
            // 设置连接
            function setupConnection(conn) {
                conn.on('open', function() {
                    console.log('连接已建立:', conn.peer);
                    connections.push(conn);
                    updatePlayerCount();
                    
                    // 发送自己的数据给新连接的玩家
                    conn.send({
                        type: 'player-data',
                        player: player
                    });
                    
                    // 请求对方发送其玩家数据
                    conn.send({
                        type: 'request-data'
                    });
                });
                
                conn.on('data', function(data) {
                    handleData(data, conn);
                });
                
                conn.on('close', function() {
                    console.log('连接已关闭:', conn.peer);
                    connections = connections.filter(c => c !== conn);
                    updatePlayerCount();
                    updateLeaderboard();
                });
                
                conn.on('error', function(err) {
                    console.error('连接错误:', err);
                });
            }
            
            // 处理收到的数据
            function handleData(data, conn) {
                switch(data.type) {
                    case 'player-data':
                        connectedPlayers[data.player.id] = {
                            ...data.player,
                            conn: conn,
                            lastSeen: Date.now()
                        };
                        updateLeaderboard();
                        break;
                        
                    case 'request-data':
                        // 收到数据请求，发送自己的数据
                        conn.send({
                            type: 'player-data',
                            player: player
                        });
                        break;
                        
                    case 'player-update':
                        if (connectedPlayers[data.player.id]) {
                            connectedPlayers[data.player.id] = {
                                ...connectedPlayers[data.player.id],
                                ...data.player,
                                lastSeen: Date.now()
                            };
                            updateLeaderboard();
                        }
                        break;
                }
            }
            
            // 广播玩家数据
            function broadcastPlayerData() {
                connections.forEach(conn => {
                    if (conn.open) {
                        conn.send({
                            type: 'player-update',
                            player: player
                        });
                    }
                });
            }
            
            // 更新排行榜
            function updateLeaderboard() {
                // 合并所有玩家数据
                const allPlayers = [player, ...Object.values(connectedPlayers)];
                
                // 按金币数量排序
                const sortedPlayers = allPlayers.sort((a, b) => b.coins - a.coins);
                
                // 清空列表
                playersListElement.innerHTML = '';
                
                // 添加玩家到排行榜
                sortedPlayers.forEach((p, index) => {
                    const li = document.createElement('li');
                    li.className = 'player-item';
                    
                    // 标记自己
                    if (p.id === player.id) {
                        li.classList.add('me');
                    }
                    
                    // 标记离线玩家（超过30秒未更新）
                    if (p.id !== player.id && Date.now() - p.lastSeen > 30000) {
                        li.classList.add('offline');
                    }
                    
                    li.innerHTML = `
                        <span class="player-name">${p.name} ${p.id === player.id ? '(你)' : ''}</span>
                        <span class="player-coins">${p.coins} 金币</span>
                    `;
                    
                    playersListElement.appendChild(li);
                });
                
                // 更新最后同步时间
                lastUpdatedElement.textContent = `最后更新: ${new Date().toLocaleTimeString()}`;
            }
            
            // 更新玩家计数
            function updatePlayerCount() {
                playerCountElement.textContent = `已连接玩家: ${connections.length + 1}`;
            }
            
            // 事件监听
            coinElement.addEventListener('click', function() {
                if (!player.name) {
                    alert('请先输入你的玩家名称并保存！');
                    return;
                }
                
                player.coins++;
                player.clicks++;
                updateDisplay();
                savePlayerData();
                broadcastPlayerData();
                updateLeaderboard();
                
                // 添加点击动画效果
                coinElement.classList.add('pulse');
                setTimeout(() => coinElement.classList.remove('pulse'), 1000);
            });
            
            saveNameButton.addEventListener('click', function() {
                const name = playerNameInput.value.trim();
                if (name) {
                    player.name = name;
                    savePlayerData();
                    broadcastPlayerData();
                    updateLeaderboard();
                    alert('玩家名称已保存！');
                } else {
                    alert('请输入有效的玩家名称');
                }
            });
            
            resetButton.addEventListener('click', function() {
                if (confirm('确定要重置游戏吗？你的金币和点击次数将清零，但玩家名称会保留。')) {
                    player.coins = 0;
                    player.clicks = 0;
                    updateDisplay();
                    savePlayerData();
                    broadcastPlayerData();
                }
            });
            
            copyLinkButton.addEventListener('click', function() {
                const url = window.location.href;
                navigator.clipboard.writeText(url).then(function() {
                    alert('邀请链接已复制！分享此链接给朋友一起玩吧！');
                }, function() {
                    alert('复制失败，请手动复制地址栏中的URL分享给朋友。');
                });
            });
            
            // 定期清理不活跃的玩家
            setInterval(() => {
                const now = Date.now();
                let updated = false;
                
                for (const id in connectedPlayers) {
                    if (now - connectedPlayers[id].lastSeen > 30000) { // 30秒无更新视为离线
                        delete connectedPlayers[id];
                        updated = true;
                    }
                }
                
                if (updated) {
                    updateLeaderboard();
                    updatePlayerCount();
                }
            }, 10000);
            
            // 在页面关闭前保存数据
            window.addEventListener('beforeunload', function() {
                savePlayerData();
            });
        });
    </script>
</body>
</html>

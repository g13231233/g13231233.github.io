<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简易联机游戏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        dark: '#1E293B',
                    },
                    fontFamily: {
                        game: ['"Press Start 2P"', 'cursive', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .game-shadow {
                box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            }
            .player-shadow {
                filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.7));
            }
            .control-btn {
                @apply w-16 h-16 md:w-20 md:h-20 rounded-full flex items-center justify-center text-white text-2xl md:text-3xl 
                       active:scale-95 transition-transform duration-100 shadow-lg;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">
    <header class="bg-dark py-4 px-6 flex justify-between items-center">
        <h1 class="text-primary text-xl md:text-2xl font-game">联机小游戏</h1>
        <div class="flex items-center gap-4">
            <div id="status" class="flex items-center gap-2">
                <span class="inline-block w-3 h-3 rounded-full bg-red-500" id="connection-indicator"></span>
                <span id="status-text">未连接</span>
            </div>
            <div id="players-count" class="flex items-center gap-1">
                <i class="fa fa-users text-secondary"></i>
                <span id="player-count">0</span>
            </div>
        </div>
    </header>

    <main class="flex-1 flex flex-col md:flex-row gap-6 p-4 md:p-8">
        <div class="w-full md:w-3/4 relative">
            <div class="relative w-full" style="padding-top: 75%;">
                <canvas id="gameCanvas" class="absolute top-0 left-0 w-full h-full bg-dark rounded-lg game-shadow"></canvas>
            </div>
            <div class="mt-4 flex justify-between items-center">
                <div>
                    <p>使用方向键或WASD移动</p>
                    <p>你的颜色: <span id="your-color" class="inline-block w-4 h-4 rounded-full bg-primary"></span></p>
                </div>
                <button id="join-btn" class="bg-primary hover:bg-primary/80 py-2 px-4 rounded-lg transition-colors">
                    加入游戏
                </button>
            </div>
        </div>

        <div class="w-full md:w-1/4 flex flex-col">
            <div class="bg-dark rounded-lg p-4 flex-1">
                <h2 class="text-xl font-bold mb-4 text-secondary">玩家列表</h2>
                <ul id="players-list" class="space-y-2">
                    <!-- 玩家列表将在这里动态生成 -->
                </ul>
            </div>

            <!-- 移动控制区 - 仅在移动设备上显示 -->
            <div class="md:hidden mt-6 grid grid-cols-3 gap-2 justify-items-center">
                <div></div>
                <button id="up" class="control-btn bg-primary">
                    <i class="fa fa-arrow-up"></i>
                </button>
                <div></div>
                
                <button id="left" class="control-btn bg-primary">
                    <i class="fa fa-arrow-left"></i>
                </button>
                <button id="down" class="control-btn bg-primary">
                    <i class="fa fa-arrow-down"></i>
                </button>
                <button id="right" class="control-btn bg-primary">
                    <i class="fa fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </main>

    <footer class="bg-dark py-4 px-6 text-center text-gray-400">
        <p>简易联机游戏演示 | 使用WebSocket实现实时多人连接</p>
    </footer>

    <script>
        // 游戏配置
        const config = {
            canvasWidth: 800,
            canvasHeight: 600,
            playerSize: 20,
            playerSpeed: 5,
            // 使用公共WebSocket服务作为中继
            wsServer: 'wss://echo.websocket.events/' // 公共测试服务器，实际使用时应更换为自己的服务器
            // 注意：公共服务器会广播所有消息，且有连接限制，仅用于演示
        };

        // 游戏状态
        const gameState = {
            canvas: null,
            ctx: null,
            socket: null,
            connected: false,
            playerId: null,
            players: {},
            keys: {
                up: false,
                down: false,
                left: false,
                right: false
            },
            lastUpdateTime: 0,
            yourColor: `hsl(${Math.random() * 360}, 70%, 50%)`
        };

        // DOM元素
        const elements = {
            connectionIndicator: document.getElementById('connection-indicator'),
            statusText: document.getElementById('status-text'),
            playerCount: document.getElementById('player-count'),
            playersList: document.getElementById('players-list'),
            joinBtn: document.getElementById('join-btn'),
            yourColor: document.getElementById('your-color'),
            controls: {
                up: document.getElementById('up'),
                down: document.getElementById('down'),
                left: document.getElementById('left'),
                right: document.getElementById('right')
            }
        };

        // 初始化游戏
        function initGame() {
            // 设置画布
            gameState.canvas = document.getElementById('gameCanvas');
            gameState.ctx = gameState.canvas.getContext('2d');
            
            // 设置画布尺寸
            gameState.canvas.width = config.canvasWidth;
            gameState.canvas.height = config.canvasHeight;
            
            // 显示玩家颜色
            elements.yourColor.style.backgroundColor = gameState.yourColor;
            
            // 注册事件监听
            registerEventListeners();
            
            // 开始游戏循环
            requestAnimationFrame(gameLoop);
        }

        // 注册事件监听
        function registerEventListeners() {
            // 加入游戏按钮
            elements.joinBtn.addEventListener('click', connectToServer);
            
            // 键盘控制
            window.addEventListener('keydown', (e) => {
                switch(e.key) {
                    case 'ArrowUp':
                    case 'w':
                    case 'W':
                        gameState.keys.up = true;
                        break;
                    case 'ArrowDown':
                    case 's':
                    case 'S':
                        gameState.keys.down = true;
                        break;
                    case 'ArrowLeft':
                    case 'a':
                    case 'A':
                        gameState.keys.left = true;
                        break;
                    case 'ArrowRight':
                    case 'd':
                    case 'D':
                        gameState.keys.right = true;
                        break;
                }
            });
            
            window.addEventListener('keyup', (e) => {
                switch(e.key) {
                    case 'ArrowUp':
                    case 'w':
                    case 'W':
                        gameState.keys.up = false;
                        break;
                    case 'ArrowDown':
                    case 's':
                    case 'S':
                        gameState.keys.down = false;
                        break;
                    case 'ArrowLeft':
                    case 'a':
                    case 'A':
                        gameState.keys.left = false;
                        break;
                    case 'ArrowRight':
                    case 'd':
                    case 'D':
                        gameState.keys.right = false;
                        break;
                }
            });
            
            // 触摸控制
            const handleTouch = (direction, isPressed) => {
                return () => {
                    gameState.keys[direction] = isPressed;
                };
            };
            
            // 触摸开始
            elements.controls.up.addEventListener('touchstart', handleTouch('up', true));
            elements.controls.down.addEventListener('touchstart', handleTouch('down', true));
            elements.controls.left.addEventListener('touchstart', handleTouch('left', true));
            elements.controls.right.addEventListener('touchstart', handleTouch('right', true));
            
            // 触摸结束
            elements.controls.up.addEventListener('touchend', handleTouch('up', false));
            elements.controls.down.addEventListener('touchend', handleTouch('down', false));
            elements.controls.left.addEventListener('touchend', handleTouch('left', false));
            elements.controls.right.addEventListener('touchend', handleTouch('right', false));
            
            // 鼠标点击控制（移动设备模拟）
            elements.controls.up.addEventListener('mousedown', handleTouch('up', true));
            elements.controls.down.addEventListener('mousedown', handleTouch('down', true));
            elements.controls.left.addEventListener('mousedown', handleTouch('left', true));
            elements.controls.right.addEventListener('mousedown', handleTouch('right', true));
            
            elements.controls.up.addEventListener('mouseup', handleTouch('up', false));
            elements.controls.down.addEventListener('mouseup', handleTouch('down', false));
            elements.controls.left.addEventListener('mouseup', handleTouch('left', false));
            elements.controls.right.addEventListener('mouseup', handleTouch('right', false));
            
            // 防止触摸事件冒泡导致页面滚动
            const controlButtons = document.querySelectorAll('.control-btn');
            controlButtons.forEach(btn => {
                btn.addEventListener('touchmove', (e) => e.preventDefault());
            });
        }

        // 连接到服务器
        function connectToServer() {
            if (gameState.connected) return;
            
            // 创建WebSocket连接
            gameState.socket = new WebSocket(config.wsServer);
            
            // 连接打开时
            gameState.socket.onopen = () => {
                console.log('已连接到服务器');
                gameState.connected = true;
                updateConnectionStatus(true);
                
                // 生成玩家ID
                gameState.playerId = 'player_' + Math.random().toString(36).substr(2, 9);
                
                // 初始化玩家位置
                gameState.players[gameState.playerId] = {
                    x: config.canvasWidth / 2,
                    y: config.canvasHeight / 2,
                    color: gameState.yourColor,
                    isYou: true
                };
                
                // 发送加入游戏消息
                sendMessage({
                    type: 'join',
                    id: gameState.playerId,
                    x: gameState.players[gameState.playerId].x,
                    y: gameState.players[gameState.playerId].y,
                    color: gameState.yourColor
                });
                
                // 禁用加入按钮
                elements.joinBtn.disabled = true;
                elements.joinBtn.textContent = "已加入";
                elements.joinBtn.classList.add('bg-gray-500');
                elements.joinBtn.classList.remove('bg-primary', 'hover:bg-primary/80');
            };
            
            // 收到消息时
            gameState.socket.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                } catch (e) {
                    console.log('收到非JSON消息:', event.data);
                }
            };
            
            // 连接关闭时
            gameState.socket.onclose = () => {
                console.log('与服务器的连接已关闭');
                gameState.connected = false;
                updateConnectionStatus(false);
                resetGameState();
            };
            
            // 连接出错时
            gameState.socket.onerror = (error) => {
                console.error('WebSocket错误:', error);
                gameState.connected = false;
                updateConnectionStatus(false);
            };
        }

        // 处理收到的消息
        function handleMessage(message) {
            // 忽略自己发送的消息
            if (message.id === gameState.playerId) return;
            
            switch(message.type) {
                case 'join':
                    // 新玩家加入
                    gameState.players[message.id] = {
                        x: message.x,
                        y: message.y,
                        color: message.color,
                        isYou: false
                    };
                    console.log(`玩家 ${message.id} 已加入`);
                    break;
                    
                case 'move':
                    // 玩家移动
                    if (gameState.players[message.id]) {
                        gameState.players[message.id].x = message.x;
                        gameState.players[message.id].y = message.y;
                    }
                    break;
                    
                case 'leave':
                    // 玩家离开
                    if (gameState.players[message.id]) {
                        delete gameState.players[message.id];
                        console.log(`玩家 ${message.id} 已离开`);
                    }
                    break;
            }
            
            // 更新玩家列表显示
            updatePlayersList();
        }

        // 发送消息
        function sendMessage(data) {
            if (gameState.connected && gameState.socket) {
                try {
                    gameState.socket.send(JSON.stringify(data));
                } catch (error) {
                    console.error('发送消息失败:', error);
                }
            }
        }

        // 更新连接状态显示
        function updateConnectionStatus(connected) {
            if (connected) {
                elements.connectionIndicator.className = 'inline-block w-3 h-3 rounded-full bg-green-500';
                elements.statusText.textContent = '已连接';
            } else {
                elements.connectionIndicator.className = 'inline-block w-3 h-3 rounded-full bg-red-500';
                elements.statusText.textContent = '未连接';
                
                // 重新启用加入按钮
                elements.joinBtn.disabled = false;
                elements.joinBtn.textContent = "加入游戏";
                elements.joinBtn.classList.remove('bg-gray-500');
                elements.joinBtn.classList.add('bg-primary', 'hover:bg-primary/80');
            }
        }

        // 更新玩家列表显示
        function updatePlayersList() {
            // 清空列表
            elements.playersList.innerHTML = '';
            
            // 更新玩家数量
            elements.playerCount.textContent = Object.keys(gameState.players).length;
            
            // 添加每个玩家到列表
            Object.keys(gameState.players).forEach(id => {
                const player = gameState.players[id];
                const li = document.createElement('li');
                li.className = 'flex items-center gap-2 p-2 bg-gray-800 rounded';
                
                const colorDot = document.createElement('span');
                colorDot.className = 'inline-block w-3 h-3 rounded-full';
                colorDot.style.backgroundColor = player.color;
                
                const playerName = document.createElement('span');
                playerName.textContent = player.isYou ? '你' : `玩家 ${id.substr(-4)}`;
                if (player.isYou) {
                    playerName.className = 'font-bold text-primary';
                }
                
                li.appendChild(colorDot);
                li.appendChild(playerName);
                elements.playersList.appendChild(li);
            });
        }

        // 重置游戏状态
        function resetGameState() {
            gameState.players = {};
            gameState.playerId = null;
            updatePlayersList();
        }

        // 更新游戏状态
        function update(deltaTime) {
            if (!gameState.connected || !gameState.playerId) return;
            
            const player = gameState.players[gameState.playerId];
            if (!player) return;
            
            let moved = false;
            
            // 根据按键状态移动玩家
            if (gameState.keys.up && player.y > config.playerSize) {
                player.y -= config.playerSpeed;
                moved = true;
            }
            if (gameState.keys.down && player.y < config.canvasHeight - config.playerSize) {
                player.y += config.playerSpeed;
                moved = true;
            }
            if (gameState.keys.left && player.x > config.playerSize) {
                player.x -= config.playerSpeed;
                moved = true;
            }
            if (gameState.keys.right && player.x < config.canvasWidth - config.playerSize) {
                player.x += config.playerSpeed;
                moved = true;
            }
            
            // 定期发送位置更新（限制发送频率）
            const now = Date.now();
            if (moved && now - gameState.lastUpdateTime > 50) { // 每50ms最多发送一次
                sendMessage({
                    type: 'move',
                    id: gameState.playerId,
                    x: player.x,
                    y: player.y
                });
                gameState.lastUpdateTime = now;
            }
        }

        // 渲染游戏
        function render() {
            // 清空画布
            gameState.ctx.fillStyle = '#1E293B';
            gameState.ctx.fillRect(0, 0, config.canvasWidth, config.canvasHeight);
            
            // 绘制网格背景
            drawGrid();
            
            // 绘制所有玩家
            Object.values(gameState.players).forEach(player => {
                gameState.ctx.fillStyle = player.color;
                gameState.ctx.beginPath();
                gameState.ctx.arc(player.x, player.y, config.playerSize, 0, Math.PI * 2);
                gameState.ctx.fill();
                
                // 为自己的玩家绘制标识
                if (player.isYou) {
                    gameState.ctx.strokeStyle = 'white';
                    gameState.ctx.lineWidth = 2;
                    gameState.ctx.beginPath();
                    gameState.ctx.arc(player.x, player.y, config.playerSize + 5, 0, Math.PI * 2);
                    gameState.ctx.stroke();
                }
            });
        }

        // 绘制网格背景
        function drawGrid() {
            gameState.ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            gameState.ctx.lineWidth = 1;
            
            const gridSize = 40;
            
            // 绘制水平线
            for (let y = 0; y <= config.canvasHeight; y += gridSize) {
                gameState.ctx.beginPath();
                gameState.ctx.moveTo(0, y);
                gameState.ctx.lineTo(config.canvasWidth, y);
                gameState.ctx.stroke();
            }
            
            // 绘制垂直线
            for (let x = 0; x <= config.canvasWidth; x += gridSize) {
                gameState.ctx.beginPath();
                gameState.ctx.moveTo(x, 0);
                gameState.ctx.lineTo(x, config.canvasHeight);
                gameState.ctx.stroke();
            }
        }

        // 游戏主循环
        function gameLoop(timestamp) {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }

        // 页面加载完成后初始化游戏
        window.addEventListener('load', initGame);
        
        // 页面关闭时发送离开消息
        window.addEventListener('beforeunload', () => {
            if (gameState.connected && gameState.playerId) {
                sendMessage({
                    type: 'leave',
                    id: gameState.playerId
                });
            }
        });
    </script>
</body>
</html>
